name: Send Payment Reminders

on:
  schedule:
    # 8am ART (UTC-3) = 11:00 UTC - Morning reminders (3-day + today)
    - cron: '0 11 * * *'
    # 7pm ART (UTC-3) = 22:00 UTC - Evening reminders (today only)
    - cron: '0 22 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      mode:
        description: 'Notification mode'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - evening

jobs:
  send-reminders:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: server
        run: npm ci

      - name: Determine notification mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" == "0 11 * * *" ]; then
            echo "mode=morning" >> $GITHUB_OUTPUT
          else
            echo "mode=evening" >> $GITHUB_OUTPUT
          fi

      - name: Send payment reminders
        working-directory: server
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: node scripts/send-reminders.js --mode ${{ steps.mode.outputs.mode }}
